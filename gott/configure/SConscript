def CheckCompilerVisibility(context):
	context.Message('Checking if compiler supports visibility attributes...')
	lastCPPDEF = context.env['CPPDEFINES'][:]
	lastSHCXXFLAGS = context.env['SHCXXFLAGS'][:]
	
	context.env.Append(CPPDEFINES = 'HAVE_VISIBILITY')
	context.env.Append(SHCXXFLAGS = '-fvisibility=hidden')

	result = context.TryCompile('int global __attribute((visibility("default")));', '.c')
	if not result:
		context.env.Replace(SHCXXFLAGS = lastSHCXXFLAGS)
		context.env.Replace(CPPDEFINES = lastCPPDEF)
	context.Result(result)
	return result

print 'Configuration...'
Import('env')
conf = Configure(env, custom_tests = {'CheckCompilerVisibility': CheckCompilerVisibility})
conf.CheckCompilerVisibility()

Return('conf')
print 'Finished configuration'
